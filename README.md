# iiko Server Updater

Консольная Python-утилита для автоматизированного обновления серверов iikoRMS и iikoChain.

## Возможности

- **Автоматический поиск серверов**: Находит локально запущенные службы iikoRMS и iikoChain и определяет их рабочие директории.
- **Поиск обновлений**: Сканирует настроенные источники (FTP и/или SMB) на наличие новых версий.
- **Безопасное обновление**:
    - Создает полный бэкап ключевых папок сервера (`exploded`, `tools`, `tomcat9`, `logs`) перед началом обновления.
    - Автоматически проверяет и предлагает изменить учетную запись службы на `LocalSystem` для предотвращения проблем с правами доступа.
    - Разворачивает новые файлы, заменяя старые.
    - Загружает и размещает необходимые `.exe` дистрибутивы (`Setup.Front.exe`, `Setup.RMS.BackOffice.exe`, `Setup.Chain.BackOffice.exe`) в соответствующие папки.
- **Интерактивный контроль**:
    - Запускает службу и отслеживает лог запуска (`startup.log`) в реальном времени.
    - Позволяет прервать мониторинг лога (`Ctrl+C`) для завершения работы в фоновом режиме.
- **Управление бэкапами**: После успешного обновления предлагает загрузить созданный архив с бэкапом на исходный ресурс (FTP/SMB) для централизованного хранения.
- **Повышение прав**: Автоматически запрашивает повышение прав администратора (UAC), если запущена от обычного пользователя.
- **Цветовое кодирование**: Использует цвета для наглядного отображения этапов, ошибок и запросов, делая процесс интуитивно понятным.

## Требования к окружению

- **Операционная система**: Windows (любая современная версия).
- **Python**: Версия 3.6 или выше.
- **Зависимости**:
    - `colorama` (для цветного вывода в консоли).

## Установка

1.  Клонируйте репозиторий или скачайте исходный код.
    ```bash
    git clone https://your-repository-url/iiko-updater.git
    cd iiko-updater
    ```
2.  (Рекомендуется) Создайте и активируйте виртуальное окружение:
    ```bash
    python -m venv .venv
    # Для Windows CMD
    .venv\Scripts\activate.bat
    # Для Windows PowerShell
    .venv\Scripts\Activate.ps1
    ```
3.  Установите единственную зависимость:
    ```bash
    pip install colorama
    ```

## Конфигурация

Перед первым запуском необходимо настроить файл `config.ini`. Если файл отсутствует, он будет создан автоматически с настройками по умолчанию при первом запуске скрипта.

### Структура `config.ini`

```ini
[FTP]
url = 

[SMB]
path = 

[Services]
keywords = Tomcat,iiko,RMS,ChainServer,iikoChain

[General]
download_dir = ./downloads
backup_dir = ./backups
```

### Примеры конфигурации

#### Пример 1: Обновление с SMB-ресурса

В этом случае все обновления и `.exe` дистрибутивы лежат на сетевой папке.

```ini
[FTP]
url = 

[SMB]
# Путь к корневой папке, где лежат директории с версиями (908, 917 и т.д.)
path = \\fileserver\shared\distr\iiko

[Services]
keywords = Tomcat,iiko,RMS,ChainServer,iikoChain

[General]
download_dir = ./downloads
backup_dir = ./backups
```
**Структура папок на SMB:**
```
\\fileserver\shared\distr\iiko\
├── 908\
│   ├── Chain_908.zip
│   ├── RMS_908.zip
│   ├── Setup.Front.exe
│   └── Setup.RMS.BackOffice.exe
└── 917\
    ├── Chain_917.zip
    ├── RMS_917.zip
    ├── Setup.Front.exe
    ├── Setup.RMS.BackOffice.exe
    └── Setup.Chain.BackOffice.exe
```
**Бэкапы будут загружаться в:** `\\fileserver\shared\temp\update_backups\`

---

#### Пример 2: Обновление с FTP-сервера

В этом случае все файлы лежат на FTP.

```ini
[FTP]
# Формат URL: ftp://[user:password@]host[:port]/path/to/versions
# Обратите внимание на использование ftp://
url = ftp://ftpuser:password123@10.0.0.5/distr/iiko

[SMB]
path = 

[Services]
keywords = Tomcat,iiko,RMS,ChainServer,iikoChain

[General]
download_dir = ./downloads
backup_dir = ./backups
```
**Структура папок на FTP:**
```
/distr/iiko/
├── 908/
│   ├── Chain_908.zip
│   └── RMS_908.zip
└── 917/
    ├── Chain_917.zip
    └── RMS_917.zip
```
**Бэкапы будут загружаться в:** `/distr/temp/update_backups/`

## Запуск

Утилиту следует запускать из консоли (CMD или PowerShell).

```bash
python iiko_updater.py
```

Скрипт автоматически определит, нужны ли права администратора, и если да — выведет запрос UAC для перезапуска с повышенными правами.

Далее следуйте интерактивным подсказкам в консоли для выбора сервера и версии обновления.

## Логика работы

1.  **Повышение прав**: Проверка и запрос UAC.
2.  **Поиск серверов**: Сканирование служб Windows по ключевым словам из `config.ini`.
3.  **Поиск обновлений**: Сканирование FTP и/или SMB путей на наличие папок с версиями.
4.  **Выбор**: Пользователь выбирает, какой сервер и какую версию установить.
5.  **Автоматический выбор архива**: На основе типа сервера (RMS/Chain) выбирается соответствующий ZIP-архив.
6.  **Проверка учетной записи**: Проверяется, что служба запускается от имени `LocalSystem`. Если нет — предлагается исправить.
7.  **Процесс обновления**:
    - Остановка службы iiko.
    - Удаление старых `.exe` дистрибутивов из рабочей директории.
    - Перемещение папок `exploded`, `tools`, `tomcat9`, `logs` в локальную папку с бэкапом.
    - Распаковка архива с обновлением.
    - Перемещение новых папок `exploded`, `tools`, `tomcat9` в рабочую директорию.
    - Загрузка и размещение `.exe` дистрибутивов в `exploded/update/...`.
    - Запуск службы iiko.
8.  **Мониторинг**: Отслеживание `startup.log` до появления сообщения `Started successfull`. Пользователь может прервать этот шаг.
9.  **Загрузка бэкапа**: Если обновление прошло успешно (или было прервано пользователем), предлагается (или автоматически выполняется) загрузка архива с бэкапом на удаленный ресурс.
10. **Очистка**: Локальная папка с бэкапом удаляется после успешной загрузки на сервер.
